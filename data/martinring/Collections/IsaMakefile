## configurables

SESSION-NAME = Collections
BASE-IMAGE = HOL

## targets

default: $(SESSION-NAME)
test: $(SESSION-NAME)
userguide: generated/Userguide.pdf
# usually empty:
images:  

all: images test userguide

## global settings
SRC = $(ISABELLE_HOME)/src
OUT = $(ISABELLE_OUTPUT)
LOG = $(OUT)/log

# turn image into absolute path according to ISABELLE_IMAGE_PATH or OUT
ifeq ($(ISABELLE_IMAGE_PATH),)
IMAGE=$(OUT)/$(BASE-IMAGE)
else
IMAGE=$(ISABELLE_IMAGE_PATH)$(BASE-IMAGE)
endif

USEDIR = $(ISABELLE_TOOL) usedir -v true -i true -V outline=/proof,/ML -d pdf -P "http://isabelle.in.tum.de/library/" -D generated

# time limit (in sec)
MAXTIME = 1200

## Collections

$(SESSION-NAME): $(OUT)/$(SESSION-NAME)

gen_algo/StdInst.thy: gen_algo/StdInst.in.thy
	scripts/inst.rb < gen_algo/StdInst.in.thy > gen_algo/StdInst.thy


impl/Impl_Overview.thy: scripts/doc.rb spec/*.thy impl/*.thy
	cat spec/*.thy impl/*.thy | scripts/doc.rb > impl/Impl_Overview.thy

$(OUT)/$(SESSION-NAME): ROOT.ML document/*.tex document/*.bib *.thy common/*.thy spec/*.thy impl/*.thy gen_algo/*.thy iterator/*.thy gen_algo/StdInst.thy impl/Impl_Overview.thy
	ulimit -t $(MAXTIME); $(USEDIR) -b $(IMAGE) $(SESSION-NAME)

generated/Userguide.pdf: $(OUT)/$(SESSION-NAME)
	cd generated; \
    $(ISABELLE_TOOL) latex -o sty "root_userguide.tex" > userguide.log;\
    $(ISABELLE_TOOL) latex -o sty "root_userguide.tex" >> userguide.log && \
    $(ISABELLE_TOOL) latex -o pdf "root_userguide.tex" >> userguide.log && \
    { [ ! -f root.bib ] || $(ISABELLE_TOOL) latex -o bbl "root_userguide.tex" >> userguide.log; } && \
    { [ ! -f root.idx ] || $(ISABELLE_TOOL) latex -o idx "root_userguide.tex" >> userguide.log; } && \
    $(ISABELLE_TOOL) latex -o pdf "root_userguide.tex" >> userguide.log && \
    $(ISABELLE_TOOL) latex -o pdf "root_userguide.tex" >> userguide.log && \
    mv root_userguide.pdf Userguide.pdf && \
    echo "Userguide at ${PWD}/Userguide.pdf"; \


## clean

clean:
	@rm -f $(LOG)/$(BASE-IMAGE)-$(SESSION-NAME).gz
	@rm -rf generated
