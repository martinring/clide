## configurables

SESSION-NAME = AutoFocus-Stream
BASE-IMAGE = Nat-Interval-Logic

## targets

default: $(SESSION-NAME)
test: $(SESSION-NAME)-test
# usually empty:
images: $(SESSION-NAME) 

all: $(SESSION-NAME)

## global settings

SRC = $(ISABELLE_HOME)/src
OUT = $(ISABELLE_OUTPUT)
LOG = $(OUT)/log

# base image is not an Isabelle release image, so always source from $(OUT)
IMAGE=$(OUT)/$(BASE-IMAGE)

DOCFLAGS = -v true -i true -V outline=/proof,/ML -g true -d pdf
USEDIR = $(ISABELLE_TOOL) usedir  $(DOCFLAGS)
BUILD = $(ISABELLE_TOOL) usedir -b $(DOCFLAGS)
BUILD_PART = $(ISABELLE_TOOL) usedir -b -v true -i false -g false -d false

# time limit (in sec)
MAXTIME = 600



# Make sure that the base image is present
$(BASE-IMAGE): 
	cd ../$(BASE-IMAGE); $(ISABELLE_TOOL) make $(BASE-IMAGE)

# test run and proof document

$(SESSION-NAME)-test: $(BASE-IMAGE) $(LOG)/$(BASE-IMAGE)-$(SESSION-NAME).gz

$(LOG)/$(BASE-IMAGE)-$(SESSION-NAME).gz: $(IMAGE) ROOT.ML \
  document/root.tex
	cd ..; ulimit -t $(MAXTIME); $(USEDIR) $(IMAGE) $(SESSION-NAME)


# build image 

$(SESSION-NAME): $(BASE-IMAGE) $(OUT)/$(SESSION-NAME)

$(OUT)/$(SESSION-NAME): $(IMAGE) ROOT.ML \
  document/root.tex
	ulimit -t $(MAXTIME); $(BUILD) $(IMAGE) $(SESSION-NAME)


## clean

clean:
	@rm -f $(LOG)/$(BASE-IMAGE)-$(SESSION-NAME).gz
	@rm -f $(OUT)/$(SESSION-NAME)